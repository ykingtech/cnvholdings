<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNV Holdings</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Noto+Sans+Sinhala:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', 'Noto Sans Sinhala', sans-serif; background: #f8fafc; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(to bottom, #ffffff, #ecfdf5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }

        .bg-icon-container { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
        .bg-icon {
            position: absolute; color: #16a34a; opacity: 0.08;
            animation: floatIcon 6s infinite ease-in-out;
        }
        @keyframes floatIcon {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.08; }
            50% { transform: translateY(-15px) scale(1.1); opacity: 0.15; }
        }

        .splash-content { position: relative; z-index: 10; text-align: center; }
        .splash-logo {
            font-size: 3.5rem; font-weight: 900; color: #1e293b; letter-spacing: -2px;
            margin-bottom: 5px; text-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .splash-sub {
            color: #15803d; letter-spacing: 4px; font-size: 0.8rem; font-weight: 800;
            margin-bottom: 40px; text-transform: uppercase;
        }

        .loader-line {
            width: 180px; height: 4px; background: #e2e8f0;
            border-radius: 10px; overflow: hidden; position: relative; margin: 0 auto;
        }
        .loader-fill {
            position: absolute; left: 0; top: 0; height: 100%; width: 40%;
            background: #16a34a; border-radius: 10px;
            animation: lineMove 1.2s infinite ease-in-out;
        }
        @keyframes lineMove { 0% { left: -40%; } 100% { left: 100%; } }

        /* --- CARD ANIMATIONS --- */
        @keyframes cardSlideUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .land-card {
            animation: cardSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }

        .view-section { height: calc(100vh - 75px); width: 100%; display: none; overflow-y: auto; scroll-behavior: smooth; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #map { width: 100%; height: 100%; z-index: 1; }

        #detail-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        #detail-view.open { transform: translateX(0); }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #e2e8f0; display: flex;
            justify-content: space-around; align-items: center; z-index: 50;
            padding-bottom: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; font-size: 10px; font-weight: 600; width: 33%; transition: color 0.3s; }
        .nav-item.active { color: #16a34a; }
        .nav-item svg { width: 24px; height: 24px; transition: transform 0.2s; }
        .nav-item.active svg { transform: translateY(-2px); }

        .dist-marker {
            background: rgba(255, 255, 255, 0.98); 
            border: 1px solid #e2e8f0; border-left: 3px solid #3b82f6; border-radius: 8px;
            padding: 5px 10px; display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 90px; max-width: 150px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000 !important;
        }
        .dist-name { font-size: 11px; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dist-val { font-size: 10px; font-weight: 600; color: #64748b; margin-top: 1px; display: flex; align-items: center; gap: 3px; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #filterModal {
            position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            display: none; align-items: flex-end; justify-content: center;
        }
        #filterModal.open { display: flex; }
        .modal-content {
            background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 24px;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .sat-btn {
            position: absolute; top: 10px; right: 10px; z-index: 400;
            background: white; padding: 8px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 10px; font-weight: bold;
            display: flex; flex-col; align-items: center; gap: 2px;
        }

        #secret-screen { background-color: black; transition: opacity 0.5s ease; }
        #loadMoreSpinner { display: none; justify-content: center; padding: 20px; }
        
        /* RETRY UI */
        .retry-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 50vh; text-align: center; color: #64748b; animation: fadeIn 0.5s;
        }
        .retry-btn {
            margin-top: 15px; background: #16a34a; color: white; padding: 12px 28px;
            border-radius: 12px; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3); transition: transform 0.2s; cursor: pointer;
        }
        .retry-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="bg-icon-container">
            <i class="fas fa-map-marker-alt bg-icon" style="top: 10%; left: 10%; font-size: 40px; animation-delay: 0s;"></i>
            <i class="fas fa-tree bg-icon" style="top: 20%; left: 25%; font-size: 24px; animation-delay: 1s;"></i>
            <i class="fas fa-home bg-icon" style="top: 5%; left: 40%; font-size: 30px; animation-delay: 2s;"></i>
            <i class="fas fa-certificate bg-icon" style="top: 15%; right: 10%; font-size: 35px; animation-delay: 0.5s;"></i>
            <i class="fas fa-key bg-icon" style="top: 30%; right: 25%; font-size: 28px; animation-delay: 1.5s;"></i>
            <i class="fas fa-handshake bg-icon" style="top: 50%; left: 5%; font-size: 45px; animation-delay: 3s;"></i>
            <i class="fas fa-tags bg-icon" style="top: 45%; right: 5%; font-size: 30px; animation-delay: 2.5s;"></i>
            <i class="fas fa-home bg-icon" style="bottom: 15%; left: 15%; font-size: 50px; animation-delay: 1s;"></i>
            <i class="fas fa-map bg-icon" style="bottom: 10%; right: 20%; font-size: 40px; animation-delay: 0s;"></i>
            <i class="fas fa-tree bg-icon" style="bottom: 25%; left: 40%; font-size: 25px; animation-delay: 2s;"></i>
            <i class="fas fa-check-circle bg-icon" style="bottom: 5%; right: 45%; font-size: 30px; animation-delay: 1.2s;"></i>
        </div>

        <div class="splash-content">
            <h1 class="splash-logo">CNV <span class="text-green-600">HOLDINGS</span></h1>
            <p class="splash-sub" id="splashText">YOUR TRUSTED LAND PARTNER</p>
            <div class="loader-line"><div class="loader-fill"></div></div>
            <p id="splashStatus" class="text-slate-400 text-[10px] mt-4 font-bold tracking-widest animate-pulse">LOADING PROPERTIES...</p>
        </div>
    </div>

    <div id="conn-status" onclick="manualCheckConnection()" class="fixed top-3 left-3 z-[1000] flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-800/80 backdrop-blur-md border border-white/10 shadow-lg cursor-pointer transition-all hover:scale-105">
        <div id="conn-dot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
        <span id="conn-text" class="text-[10px] font-bold text-white tracking-widest uppercase">CHECKING</span>
    </div>

    <div id="secret-screen" class="fixed inset-0 z-[99999] hidden flex-col items-center justify-center text-center p-6 opacity-0" onclick="closeSecret()">
        <div class="space-y-4 animate-[popIn_0.5s_ease-out]">
            <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400 tracking-tighter" style="font-family: 'Courier New', monospace;">THE KINA</h1>
            <p class="text-gray-400 text-sm tracking-[0.5em] uppercase animate-pulse">System Developer</p>
            <div class="mt-10 border border-gray-800 rounded-full px-4 py-2 text-xs text-gray-600 inline-block">Tap anywhere to exit</div>
        </div>
    </div>

    <div id="view-list" class="view-section active bg-gray-50">
        <div class="sticky top-0 bg-white/90 backdrop-blur-xl z-20 px-5 pt-10 pb-4 border-b border-slate-100 shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Discover Lands üè°</h1>
                <button onclick="openFilter()" class="bg-slate-100 p-2 rounded-xl text-slate-600 hover:bg-green-50 hover:text-green-600 transition"><i class="fas fa-sliders-h"></i></button>
            </div>
            <div class="flex gap-2">
                <div class="relative flex-1 shadow-sm">
                    <input type="text" id="searchInput" placeholder="Search city (e.g. Kandy / ‡∂±‡∑î‡∑Ä‡∂ª)..." 
                           class="w-full bg-slate-100/50 border-none rounded-xl py-3 pl-10 pr-4 outline-none focus:ring-2 focus:ring-green-500/20 text-sm font-semibold text-slate-700">
                    <span class="absolute left-3.5 top-3 text-slate-400">üîç</span>
                </div>
                <div class="relative">
                    <select id="sortOption" onchange="sortLands()" class="appearance-none bg-slate-100 border-none rounded-xl py-3 pl-3 pr-8 outline-none text-xs font-bold text-slate-600 h-full">
                        <option value="new">üÜï Newest</option>
                        <option value="price_asc">üí∞ Lowest Price</option>
                        <option value="price_desc">üíé Highest Price</option>
                    </select>
                    <span class="absolute right-2 top-3.5 text-slate-400 text-xs pointer-events-none">‚ñº</span>
                </div>
            </div>
        </div>

        <div id="landList" class="p-5 space-y-4 min-h-[60vh]"></div>
        <div id="loadMoreSpinner"><div class="w-6 h-6 border-2 border-slate-300 border-t-blue-500 rounded-full animate-spin"></div></div>

        <footer class="text-center py-8 text-slate-400 pb-24">
            <h3 class="font-black text-slate-200 text-3xl tracking-tighter mb-2">CNV</h3>
            <p class="text-[10px] font-bold uppercase tracking-widest">Real Estate Solutions</p>
            <p class="text-[10px] mt-1">¬© 2025 CNV Holdings. All Rights Reserved.</p>
        </footer>
    </div>

    <div id="view-fav" class="view-section bg-gray-50">
        <div class="sticky top-0 bg-white/90 backdrop-blur-xl z-20 px-6 pt-12 pb-4 border-b border-slate-100">
            <h1 class="text-2xl font-bold text-slate-900">Saved Lands ‚ù§Ô∏è</h1>
        </div>
        <div id="favList" class="p-5 space-y-4 pb-32 min-h-[50vh] flex flex-col items-center justify-center">
            <p class="text-slate-400 text-sm">No saved items yet.</p>
        </div>
    </div>

    <div id="view-map" class="view-section relative">
        <div id="map"></div>
        <button class="sat-btn" onclick="toggleSat()"><span class="text-lg">üõ∞Ô∏è</span><span>Sat</span></button>
        <div id="mapFloatCard" class="absolute bottom-24 left-4 right-4 bg-white p-3 rounded-2xl shadow-2xl z-[500] hidden flex gap-4 items-center cursor-pointer border-l-4 border-green-500 animate-[slideUp_0.3s_ease]" onclick="openDetailFromMap()">
            <img id="mapCardImg" class="w-16 h-16 rounded-xl object-cover bg-slate-200">
            <div class="flex-1 min-w-0">
                <h3 id="mapCardTitle" class="font-bold text-slate-800 text-sm truncate">Title</h3>
                <p id="mapCardLocation" class="text-xs text-slate-500 mb-1 truncate">Location</p>
                <div class="flex justify-between items-center">
                    <p id="mapCardPrice" class="text-green-600 font-bold text-xs"></p>
                    <span class="text-[10px] bg-slate-100 px-2 py-1 rounded-full text-slate-500 font-bold">Details ‚Üí</span>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-view">
        <div class="flex justify-between items-center p-4 pt-10 bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-slate-50">
            <button onclick="closeDetail()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-times"></i></button>
            <h3 class="font-bold text-slate-800 text-sm tracking-wide">DETAILS</h3>
            <button onclick="shareLink()" class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-600"><i class="fas fa-share-alt"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto bg-white pb-10">
            <div class="h-80 bg-slate-200 relative group">
                <img id="detailImg" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                <div class="absolute bottom-0 left-0 p-6 w-full">
                    <div class="flex gap-2 mb-2">
                         <span id="detailBadge" class="inline-block px-3 py-1 rounded-lg text-[10px] font-bold uppercase text-white shadow-lg"></span>
                         <span id="detailNewBadge" class="hidden px-3 py-1 rounded-lg text-[10px] font-bold uppercase text-white shadow-lg bg-blue-500 animate-pulse">NEW</span>
                    </div>
                    <h2 id="detailTitle" class="text-2xl font-bold text-white leading-tight"></h2>
                </div>
                <button onclick="slide(-1)" class="absolute left-4 top-1/2 bg-white/20 text-white w-10 h-10 flex items-center justify-center rounded-full backdrop-blur-md">‚ùÆ</button>
                <button onclick="slide(1)" class="absolute right-4 top-1/2 bg-white/20 text-white w-10 h-10 flex items-center justify-center rounded-full backdrop-blur-md">‚ùØ</button>
            </div>
            <div class="p-6">
                <div class="flex justify-between items-end mb-6">
                    <div><p class="text-xs font-bold text-slate-400 uppercase">Price</p><p id="detailPrice" class="text-3xl font-bold text-green-600"></p></div>
                    <div class="text-right"><p class="text-xs font-bold text-slate-400 uppercase">Size</p><p id="detailPerches" class="text-xl font-bold text-slate-800"></p></div>
                </div>
                <p id="detailLocation" class="text-slate-600 font-medium mb-6 flex items-center gap-2 bg-slate-50 p-3 rounded-xl border border-slate-100"><span class="text-lg">üìç</span> <span class="text-sm">Location</span></p>
                <div class="grid grid-cols-3 gap-2 mb-8">
                    <button onclick="viewOnMap()" class="bg-slate-100 text-slate-700 py-3 rounded-xl font-bold text-[10px] flex flex-col items-center justify-center gap-1 hover:bg-slate-200"><span class="text-lg">üó∫Ô∏è</span> App Map</button>
                    <button onclick="openGoogleMaps()" class="bg-blue-50 text-blue-600 py-3 rounded-xl font-bold text-[10px] flex flex-col items-center justify-center gap-1 hover:bg-blue-100"><span class="text-lg">üöó</span> Directions</button>
                    <button onclick="openStreetView()" class="bg-yellow-50 text-yellow-600 py-3 rounded-xl font-bold text-[10px] flex flex-col items-center justify-center gap-1 hover:bg-yellow-100"><span class="text-lg">üåè</span> Street View</button>
                </div>
                <div class="mb-8"><h3 class="font-bold text-slate-900 mb-3 text-lg">Description</h3><p id="detailDesc" class="text-slate-600 text-sm leading-7 whitespace-pre-line"></p></div>
                <div class="mb-8"><h3 class="font-bold text-slate-900 mb-3 text-lg">Nearby Highlights</h3><div id="nearbyList" class="space-y-2 text-sm text-slate-500 bg-slate-50 p-4 rounded-2xl border border-slate-100"></div></div>
                <div class="bg-green-50 p-5 rounded-2xl border border-green-100 mb-8">
                    <h3 class="font-bold text-green-800 mb-2">ü§ù Make an Offer</h3>
                    <p class="text-xs text-green-600 mb-3">Interested? Propose your price below.</p>
                    <div class="flex gap-2">
                        <input type="number" id="offerInput" placeholder="Rs. Your Offer" class="flex-1 px-3 py-2 rounded-lg border-none text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-green-400">
                        <button onclick="sendOffer()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md">Send</button>
                    </div>
                </div>
                <div><h3 class="font-bold text-slate-900 mb-3 text-lg">You Might Also Like</h3><div id="similarList" class="space-y-3"></div></div>
            </div>
        </div>
        <div class="p-4 bg-white border-t border-slate-100 grid grid-cols-2 gap-4 pb-8">
            <a id="waBtn" href="#" target="_blank" class="bg-[#25D366] text-white py-3.5 rounded-xl font-bold text-center flex items-center justify-center gap-2 shadow-lg"><i class="fab fa-whatsapp text-lg"></i> WhatsApp</a>
            <a href="tel:+94726284277" class="bg-slate-900 text-white py-3.5 rounded-xl font-bold text-center flex items-center justify-center gap-2"><i class="fas fa-phone-alt"></i> Call Now</a>
        </div>
    </div>

    <div id="filterModal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-900">Filter Properties</h2>
                <button onclick="closeFilter()" class="text-slate-500 text-2xl">‚úï</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-bold text-slate-600 mb-2 block">Max Price</label>
                    <input type="range" id="priceRange" min="0" max="5000000" step="50000" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-600">
                    <p class="text-right text-green-600 font-bold mt-1" id="priceVal">Any</p>
                </div>
                <div><label class="text-sm font-bold text-slate-600 mb-2 block">Min Perches</label><input type="number" id="perchMin" placeholder="e.g. 10" class="w-full p-3 bg-slate-50 rounded-xl border outline-none"></div>
                <button onclick="applyFilter()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg">Apply Filters</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button onclick="switchTab('list')" id="nav-list" class="nav-item active"><i class="fas fa-home text-lg"></i><span>Home</span></button>
        <button onclick="switchTab('fav')" id="nav-fav" class="nav-item"><i class="fas fa-heart text-lg"></i><span>Saved</span></button>
        <button onclick="switchTab('map')" id="nav-map" class="nav-item"><i class="fas fa-map text-lg"></i><span>Map</span></button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA30v8yswbyqF-oB29C7DXPWpKwCQscs5o", authDomain: "land-425be.firebaseapp.com", projectId: "land-425be", storageBucket: "land-425be.firebasestorage.app", messagingSenderId: "1053755182230", appId: "1:1053755182230:web:9596bee1de56a3c63e86b7", measurementId: "G-DQVYCKN9KY" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- OFFLINE DATA SAVE (PERSISTENCE) ---
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
            } else if (err.code == 'unimplemented') {
                console.log('The current browser does not support all of the features required to enable persistence');
            }
        });

        // --- CONNECTION STATUS LOGIC ---
        function checkConnection() {
            // Tries to fetch a tiny file from a reliable CDN to test internet
            return fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-store' })
                .then(() => true)
                .catch(() => false);
        }

        function updateConnUI(status) {
            const dot = document.getElementById('conn-dot');
            const txt = document.getElementById('conn-text');
            const box = document.getElementById('conn-status');
            
            if(status === 'online') {
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                txt.innerText = "ONLINE";
                box.className = "fixed top-3 left-3 z-[1000] flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-900/80 backdrop-blur-md border border-emerald-500/30 shadow-lg cursor-pointer transition-all hover:scale-105";
            } else if(status === 'offline') {
                dot.className = "w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444] animate-pulse";
                txt.innerText = "OFFLINE";
                box.className = "fixed top-3 left-3 z-[1000] flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-900/80 backdrop-blur-md border border-red-500/30 shadow-lg cursor-pointer transition-all hover:scale-105";
            } else {
                dot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                txt.innerText = "CHECKING";
                box.className = "fixed top-3 left-3 z-[1000] flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-800/80 backdrop-blur-md border border-white/10 shadow-lg cursor-pointer transition-all hover:scale-105";
            }
        }

        window.manualCheckConnection = async () => {
            updateConnUI('checking');
            const isOnline = await checkConnection();
            updateConnUI(isOnline ? 'online' : 'offline');
            if(isOnline && landsData.length === 0) loadLands(); // Retry load if empty
        };

        window.addEventListener('online', () => manualCheckConnection());
        window.addEventListener('offline', () => updateConnUI('offline'));
        
        // Initial check
        manualCheckConnection();

        const cityMapping = { "‡∂ö‡∑ú‡∑Ö‡∂π": "colombo", "‡∂±‡∑î‡∂ú‡∑ö‡∂ú‡∑ú‡∂©": "nugegoda", "‡∂∏‡∑Ñ‡∂ª‡∂ú‡∂∏": "maharagama", "‡∂¥‡∑í‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂Ø‡∂Ω": "piliyandala", "‡∂ö‡∑ê‡∑É‡∑ä‡∂∂‡∑ë‡∑Ä": "kesbewa", "‡∂∂‡∂´‡∑ä‡∂©‡∑è‡∂ª‡∂ú‡∂∏": "bandaragama", "‡∑Ñ‡∑ú‡∂ª‡∂´": "horana", "‡∂¥‡∑è‡∂±‡∂Ø‡∑î‡∂ª": "panadura", "‡∑Ä‡∑è‡∂Ø‡∑ä‡∂Ø‡∑î‡∑Ä": "wadduwa", "‡∂ö‡∑Ö‡∑î‡∂≠‡∂ª": "kalutara", "‡∂∏‡∂≠‡∑î‡∂ú‡∂∏": "mathugama", "‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∂ú‡∂∏": "aluthgama", "‡∂∂‡∑ô‡∂±‡∑ä‡∂≠‡∑ú‡∂ß": "bentota", "‡∂Ö‡∂∏‡∑ä‡∂∂‡∂Ω‡∂±‡∑ä‡∂ú‡∑ú‡∂©": "ambalangoda", "‡∑Ñ‡∑í‡∂ö‡∑ä‡∂ö‡∂©‡∑î‡∑Ä": "hikkaduwa", "‡∂ú‡∑è‡∂Ω‡∑ä‡∂Ω": "galle", "‡∂∏‡∑è‡∂≠‡∂ª": "matara", "‡∑Ä‡∑ê‡∂Ω‡∑í‡∂ú‡∂∏": "weligama", "‡∑Ñ‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂≠‡∑ú‡∂ß": "hambantota", "‡∂≠‡∂Ç‡∂ú‡∂Ω‡∑ä‡∂Ω": "tangalle", "‡∂á‡∂π‡∑í‡∂Ω‡∑í‡∂¥‡∑í‡∂ß‡∑í‡∂∫": "embilipitiya", "‡∂ª‡∂≠‡∑ä‡∂±‡∂¥‡∑î‡∂ª": "rathnapura", "‡∂Ö‡∑Ä‡∑í‡∑É‡∑ä‡∑É‡∑è‡∑Ä‡∑ö‡∂Ω‡∑ä‡∂Ω": "avissawella", "‡∑Ñ‡∑ù‡∂∏‡∑è‡∂ú‡∂∏": "homagama", "‡∂ö‡∑ú‡∂ß‡∑ä‡∂ß‡∑è‡∑Ä": "kottawa", "‡∂∏‡∑è‡∂Ω‡∂∂‡∑ö": "malabe", "‡∂∂‡∂≠‡∑ä‡∂≠‡∂ª‡∂∏‡∑î‡∂Ω‡∑ä‡∂Ω": "battaramulla", "‡∂ª‡∑è‡∂¢‡∂ú‡∑í‡∂ª‡∑í‡∂∫": "rajagiriya", "‡∂ö‡∂©‡∑Ä‡∂≠": "kadawatha", "‡∂ö‡∑ê‡∂Ω‡∂´‡∑í‡∂∫": "kelaniya", "‡∑Ä‡∂≠‡∑ä‡∂≠‡∂Ω": "wattala", "‡∂¢‡∑è‡∂á‡∂Ω": "ja-ela", "‡∂∏‡∑ì‡∂ú‡∂∏‡∑î‡∑Ä": "negombo", "‡∂ú‡∂∏‡∑ä‡∂¥‡∑Ñ": "gampaha", "‡∑Ä‡∑ö‡∂∫‡∂±‡∑ä‡∂ú‡∑ú‡∂©": "veyangoda", "‡∂±‡∑í‡∂ß‡∑ä‡∂ß‡∂π‡∑î‡∑Ä": "nittambuwa", "‡∑Ä‡∂ª‡∂ö‡∑è‡∂¥‡∑ú‡∂Ω": "warakapola", "‡∂ö‡∑ë‡∂ú‡∂Ω‡∑ä‡∂Ω": "kegalle", "‡∂∏‡∑è‡∑Ä‡∂±‡∑ê‡∂Ω‡∑ä‡∂Ω": "mawanella", "‡∂±‡∑î‡∑Ä‡∂ª": "kandy", "‡∂∏‡∑Ñ‡∂±‡∑î‡∑Ä‡∂ª": "kandy", "‡∂¥‡∑ö‡∂ª‡∑è‡∂Ø‡∑ô‡∂´‡∑í‡∂∫": "peradeniya", "‡∂ú‡∂∏‡∑ä‡∂¥‡∑ú‡∂Ω": "gampola", "‡∂±‡∑è‡∑Ä‡∂Ω‡∂¥‡∑í‡∂ß‡∑í‡∂∫": "nawalapitiya", "‡∑Ñ‡∑ê‡∂ß‡∂±‡∑ä": "hatton", "‡∂±‡∑î‡∑Ä‡∂ª‡∂ë‡∑Ö‡∑í‡∂∫": "nuwaraeliya", "‡∂∂‡∂´‡∑ä‡∂©‡∑è‡∂ª‡∑Ä‡∑ô‡∂Ω": "bandarawela", "‡∂∂‡∂Ø‡∑î‡∂Ω‡∑ä‡∂Ω": "badulla", "‡∂∏‡∑ú‡∂´‡∂ª‡∑è‡∂ú‡∂Ω": "monaragala", "‡∂ö‡∑î‡∂ª‡∑î‡∂´‡∑ë‡∂ú‡∂Ω": "kurunegala", "‡∑Ä‡∑è‡∂ª‡∑í‡∂∫‡∂¥‡∑ú‡∂Ω": "wariyapola", "‡∂ö‡∑î‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∑í‡∂ß‡∑í‡∂∫": "kuliyapitiya", "‡∂¥‡∑î‡∂≠‡∑ä‡∂≠‡∂Ω‡∂∏": "puttalam", "‡∑Ñ‡∂Ω‡∑è‡∑Ä‡∂≠": "chilaw", "‡∂Ö‡∂±‡∑î‡∂ª‡∑è‡∂∞‡∂¥‡∑î‡∂ª‡∂∫": "anuradhapura", "‡∂¥‡∑ú‡∑Ö‡∑ú‡∂±‡∑ä‡∂±‡∂ª‡∑î‡∑Ä": "polonnaruwa", "‡∂Ø‡∂π‡∑î‡∂Ω‡∑ä‡∂Ω": "dambulla", "‡∑É‡∑ì‡∂ú‡∑í‡∂ª‡∑í‡∂∫": "sigiriya", "‡∂≠‡∑ä‚Äç‡∂ª‡∑í‡∂ö‡∑î‡∂´‡∑è‡∂∏‡∂Ω‡∂∫": "trincomalee", "‡∂∏‡∂©‡∂ö‡∂Ω‡∂¥‡∑î‡∑Ä": "batticaloa", "‡∂∫‡∑è‡∂¥‡∂±‡∂∫": "jaffna" };

        const streetLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png');
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        const map = L.map('map', { zoomControl: false, tap: false, layers: [streetLayer] }).setView([6.9271, 79.8612], 9);
        let currentLayer = 'street';
        window.toggleSat = () => { if(currentLayer === 'street') { map.removeLayer(streetLayer); map.addLayer(satLayer); currentLayer='sat'; } else { map.removeLayer(satLayer); map.addLayer(streetLayer); currentLayer='street'; } };

        let landsData = []; let displayedData = []; let renderCount = 0; const BATCH_SIZE = 5; 
        let nearbyLayer = L.layerGroup().addTo(map); let landLayer = L.layerGroup().addTo(map); 
        let selectedLandId = null; let favorites = JSON.parse(localStorage.getItem('cnv_favs')) || [];
        
        // --- RELIABLE TIMERS ---
        let slowNetTimer = null;

        window.switchTab = (tab) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            document.getElementById(`nav-${tab}`).classList.add('active');
            if(tab === 'map') setTimeout(() => map.invalidateSize(), 100);
            if(tab === 'fav') renderFavorites();
        };

        async function loadLands() {
            try {
                const now = new Date();
                
                // 1. SIGNAL MONITORING
                clearTimeout(slowNetTimer);
                slowNetTimer = setTimeout(() => {
                    document.getElementById('splashStatus').innerText = "SIGNAL IS WEAK... USING OFFLINE DATA...";
                    document.getElementById('splashText').innerText = "PLEASE WAIT";
                }, 4000);

                // --- STAGE 1: Quick Fetch ---
                try {
                    // Cache ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∑Ñ‡∂ª‡∑í ‡∂â‡∂ö‡∑ä‡∂∏‡∂±‡∂ß ‡∂©‡∑ö‡∂ß‡∑è ‡∂ë‡∂±‡∑Ä‡∂Ø ‡∂∂‡∂Ω‡∂±‡∑Ä‡∑è
                    const qLimit = query(collection(db, "lands"), limit(5)); 
                    const snapLimit = await getDocs(qLimit);
                    
                    if(!snapLimit.empty) {
                        let initialData = [];
                        snapLimit.forEach(doc => {
                            const data = doc.data(); data.id = doc.id;
                            let landDate = data.timestamp && data.timestamp.seconds ? new Date(data.timestamp.seconds * 1000) : (data.timestamp ? new Date(data.timestamp) : new Date(0));
                            data.sortDate = landDate; 
                            const diffDays = Math.ceil(Math.abs(now - landDate) / (1000 * 60 * 60 * 24));
                            data.isNew = diffDays <= 7;
                            if (data.status === 'sold' && data.soldAt) {
                               const sDate = new Date(data.soldAt.seconds ? data.soldAt.seconds*1000 : data.soldAt);
                               if(Math.ceil(Math.abs(now - sDate) / 86400000) > 3) return;
                            }
                            if(!data.imageUrls) data.imageUrls = [data.imageUrl];
                            initialData.push(data);
                        });
                    }
                } catch(quickErr) { console.log("Quick load skipped..."); }

                // --- STAGE 2: Full Load ---
                const qAll = query(collection(db, "lands")); 
                // Persistence On ‡∂ö‡∂ª‡∂Ω‡∑è ‡∂≠‡∑í‡∂∫‡∑ô‡∂± ‡∂±‡∑í‡∑É‡∑è ‡∑É‡∑í‡∂ú‡∑ä‡∂±‡∂Ω‡∑ä ‡∂±‡∑ê‡∂≠‡∑í ‡∑Ä‡∑î‡∂±‡∂≠‡∑ä ‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂ö‡∂Ω‡∑í‡∂±‡∑ä ‡∂Ω‡∑ù‡∂©‡∑ä ‡∑Ä‡∑î‡∂± ‡∂©‡∑ö‡∂ß‡∑è ‡∂ë‡∂±‡∑Ä‡∑è
                const snapAll = await getDocs(qAll);
                
                clearTimeout(slowNetTimer);

                let fullData = [];
                snapAll.forEach(doc => {
                    const data = doc.data(); data.id = doc.id;
                    let landDate = data.timestamp && data.timestamp.seconds ? new Date(data.timestamp.seconds * 1000) : (data.timestamp ? new Date(data.timestamp) : new Date(0));
                    data.sortDate = landDate; 
                    const diffDays = Math.ceil(Math.abs(now - landDate) / (1000 * 60 * 60 * 24));
                    data.isNew = diffDays <= 7;
                    if (data.status === 'sold' && data.soldAt) {
                       const sDate = new Date(data.soldAt.seconds ? data.soldAt.seconds*1000 : data.soldAt);
                       if(Math.ceil(Math.abs(now - sDate) / 86400000) > 3) return;
                    }
                    if(!data.imageUrls) data.imageUrls = [data.imageUrl];
                    fullData.push(data);
                });

                fullData.sort((a, b) => b.sortDate - a.sortDate);
                landsData = fullData;

                // CRITICAL LOGIC: ONLY ENTER IF DATA EXISTS
                if (fullData.length > 0) {
                    displayedData = [...landsData];
                    resetRender();
                    updateMapMarkers(landsData);
                    
                    const splash = document.getElementById('splash-screen');
                    splash.style.opacity = '0';
                    splash.style.visibility = 'hidden';
                } else {
                    throw new Error("Empty Data");
                }

                const params = new URLSearchParams(window.location.search);
                if(params.get('id')) { const l = landsData.find(x=>x.id===params.get('id')); if(l) openDetail(l); }

            } catch (e) { 
                console.error("Retrying...", e);
                document.getElementById('splashStatus').innerText = "CONNECTING TO SERVER...";
                setTimeout(loadLands, 2000); // Auto Retry
            }
        }

        function updateMapMarkers(dataArray) {
            landLayer.clearLayers();
            dataArray.forEach(data => {
                if(!data.lat || !data.lng) return;
                const isSelected = data.id === selectedLandId;
                let color = data.status === 'sold' ? '#ef4444' : '#16a34a';
                if(isSelected) color = '#3b82f6'; 

                const size = isSelected ? 30 : 24;
                const border = isSelected ? '4px solid white' : '3px solid white';
                const zIndex = isSelected ? 1000 : 1;

                const icon = L.divIcon({ 
                    className: '', 
                    html: `<div style="background:${color}; width:${size}px; height:${size}px; border-radius:50%; border:${border}; box-shadow:0 4px 10px rgba(0,0,0,0.3); transition: all 0.3s ease;"></div>`,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });

                const marker = L.marker([data.lat, data.lng], {icon: icon, zIndexOffset: zIndex});
                marker.on('click', () => { 
                    selectedLandId = data.id; 
                    updateMapMarkers(displayedData); 
                    showFloatingCard(data); 
                    map.flyTo([data.lat, data.lng], 14); 
                    calcDistanceOnMap(data.lat, data.lng);
                });
                marker.addTo(landLayer);
            });
        }

        function resetRender() { renderCount = 0; document.getElementById('landList').innerHTML = ''; renderNextBatch(); }
        function renderNextBatch() {
            const listDiv = document.getElementById('landList'); const spinner = document.getElementById('loadMoreSpinner');
            if(renderCount >= displayedData.length) { 
                spinner.style.display = 'none'; 
                return; 
            }
            const nextBatch = displayedData.slice(renderCount, renderCount + BATCH_SIZE);
            nextBatch.forEach((data, index) => renderCard(data, listDiv, index));
            renderCount += BATCH_SIZE;
            spinner.style.display = renderCount < displayedData.length ? 'flex' : 'none';
        }
        document.getElementById('view-list').addEventListener('scroll', function() { if(this.scrollTop + this.clientHeight >= this.scrollHeight - 100 && document.getElementById('loadMoreSpinner').style.display === 'flex') renderNextBatch(); });

        function formatSize(d) { const size = d.size || d.perches; const unit = d.sizeUnit === 'acre' ? 'Acres' : 'P'; return `${size} ${unit}`; }
        function formatPrice(d) { const price = d.price || d.pricePerPerch; const type = d.priceType === 'total' ? 'Total' : (d.sizeUnit === 'acre' ? '/ Acre' : '/ P'); return `Rs. ${price} <span class="text-slate-400 text-xs font-normal">${type}</span>`; }

        function renderCard(data, container, index = 0) {
            const isSold = data.status === 'sold'; const isFav = favorites.includes(data.id);
            const div = document.createElement('div');
            div.className = "land-card bg-white p-3 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition cursor-pointer flex gap-4 group relative";
            div.style.animationDelay = `${index * 0.1}s`;
            div.innerHTML = `<div class="w-24 h-24 rounded-xl overflow-hidden flex-shrink-0 relative bg-slate-100"><img src="${data.imageUrls?.[0] || ''}" class="w-full h-full object-cover">${isSold ? '<div class="absolute inset-0 bg-red-500/50 flex items-center justify-center"><span class="bg-red-600 border border-white text-white text-[10px] font-extrabold px-2 py-0.5 rounded-full">SOLD</span></div>' : ''}${!isSold && data.isNew ? '<div class="absolute top-0 left-0 bg-blue-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-br-lg shadow">NEW</div>' : ''}</div><div class="flex-1 flex flex-col justify-center min-w-0" onclick="openDetail(this.parentElement.data)"><h3 class="font-bold text-slate-800 text-lg leading-tight mb-1 truncate">${data.title}</h3><p class="text-xs text-slate-500 mb-1 truncate">üìç ${data.location}</p><p class="text-green-600 font-bold text-base">${formatPrice(data)}</p></div><button onclick="toggleFav('${data.id}', this)" class="absolute top-2 right-2 p-2 rounded-full ${isFav ? 'text-red-500' : 'text-gray-300 hover:text-red-400'}"><i class="fas fa-heart"></i></button>`;
            div.data = data; container.appendChild(div);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            if(term === 'the kina' || term === 'thekina') { document.getElementById('secret-screen').classList.remove('hidden'); setTimeout(() => document.getElementById('secret-screen').classList.remove('opacity-0'), 50); return; }
            if(term === "") { displayedData = [...landsData]; } 
            else { 
                const mappedTerm = cityMapping[term] || term;
                displayedData = landsData.filter(l => l.location.toLowerCase().includes(term) || l.location.toLowerCase().includes(mappedTerm) || l.title.toLowerCase().includes(term));
            }
            resetRender();
            updateMapMarkers(displayedData);
        });

        window.closeSecret = () => { const secret = document.getElementById('secret-screen'); secret.classList.add('opacity-0'); setTimeout(() => { secret.classList.add('hidden'); document.getElementById('searchInput').value = ""; displayedData = [...landsData]; resetRender(); updateMapMarkers(landsData); }, 500); };
        window.sortLands = () => { const opt = document.getElementById('sortOption').value; let sorted = [...landsData]; if(opt === 'price_asc') sorted.sort((a, b) => (a.sortPrice || 0) - (b.sortPrice || 0)); else if(opt === 'price_desc') sorted.sort((a, b) => (b.sortPrice || 0) - (a.sortPrice || 0)); else sorted.sort((a,b) => b.sortDate - a.sortDate); landsData = sorted; displayedData = [...sorted]; resetRender(); };
        window.openGoogleMaps = () => { if(!currentLand) return; window.open(`http://maps.google.com/maps?q=${currentLand.lat},${currentLand.lng}`, '_blank'); };
        window.openStreetView = () => { if(!currentLand) return; window.open(`https://www.google.com/maps?q=&layer=c&cbll=${currentLand.lat},${currentLand.lng}`, '_blank'); };
        
        window.sendOffer = () => {
            const amount = document.getElementById('offerInput').value;
            if(!amount) return alert("Please enter an amount!");
            const shareUrl = `${window.location.origin}${window.location.pathname}?id=${currentLand.id}`;
            const msg = `Hi, I am interested in ${currentLand.title} (${shareUrl}). My offer is Rs. ${amount}. Can we discuss?`;
            window.open(`https://wa.me/94726284277?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.toggleFav = (id, btn) => { if(favorites.includes(id)) { favorites = favorites.filter(x => x !== id); btn.classList.remove('text-red-500'); btn.classList.add('text-gray-300'); } else { favorites.push(id); btn.classList.add('text-red-500'); btn.classList.remove('text-gray-300'); } localStorage.setItem('cnv_favs', JSON.stringify(favorites)); if(document.getElementById('view-fav').classList.contains('active')) renderFavorites(); };
        function renderFavorites() { const container = document.getElementById('favList'); container.innerHTML = ""; if(favorites.length === 0) { container.innerHTML = '<p class="text-slate-400 text-center mt-10">No saved items.</p>'; return; } favorites.forEach(id => { const l = landsData.find(x=>x.id===id); if(l) renderCard(l, container); }); }
        
        window.openFilter = () => document.getElementById('filterModal').classList.add('open');
        window.closeFilter = () => document.getElementById('filterModal').classList.remove('open');
        document.getElementById('priceRange').addEventListener('input', function() { document.getElementById('priceVal').innerText = this.value == 0 ? "Any" : "Max: Rs. " + Number(this.value).toLocaleString(); });
        window.applyFilter = () => {
            const maxPrice = document.getElementById('priceRange').value;
            const minPerch = document.getElementById('perchMin').value;
            displayedData = landsData.filter(l => {
                let valid = true;
                const size = l.size || l.perches || 0;
                const totalPerches = (l.sizeUnit === 'acre') ? size * 160 : size;
                if(maxPrice > 0 && (l.sortPrice || 0) > maxPrice) valid = false;
                if(minPerch && totalPerches < minPerch) valid = false;
                return valid;
            });
            resetRender(); updateMapMarkers(displayedData); closeFilter();
        };

        let selectedLandFromMap = null; 
        function showFloatingCard(data) { 
            selectedLandFromMap = data; 
            document.getElementById('mapFloatCard').classList.remove('hidden'); 
            document.getElementById('mapCardImg').src = data.imageUrls?.[0]; 
            document.getElementById('mapCardTitle').innerText = data.title; 
            document.getElementById('mapCardLocation').innerText = data.location; 
            document.getElementById('mapCardPrice').innerHTML = formatPrice(data); 
        } 
        window.openDetailFromMap = () => { if(selectedLandFromMap) openDetail(selectedLandFromMap); };
        
        let currentImgs = []; let idx = 0; let currentLand = null; 
        window.openDetail = (data) => { 
            currentLand = data; currentImgs = data.imageUrls; idx = 0; 
            selectedLandId = data.id; 
            updateMapMarkers(displayedData); 

            document.getElementById('mapFloatCard').classList.add('hidden'); 
            document.getElementById('detailImg').src = currentImgs[0]; 
            document.getElementById('detailTitle').innerText = data.title; 
            document.getElementById('detailLocation').innerText = data.location; 
            document.getElementById('detailPerches').innerText = formatSize(data); 
            document.getElementById('detailPrice').innerHTML = formatPrice(data); 
            document.getElementById('detailDesc').innerText = data.description; 
            const isSold = data.status === 'sold'; 
            const badge = document.getElementById('detailBadge'); 
            badge.innerText = isSold ? 'SOLD OUT' : 'AVAILABLE'; 
            badge.className = `inline-block px-3 py-1 rounded-lg text-[10px] font-bold uppercase text-white shadow-lg mb-2 ${isSold ? 'bg-red-600' : 'bg-green-600'}`; 
            if(data.isNew && !isSold) document.getElementById('detailNewBadge').classList.remove('hidden'); else document.getElementById('detailNewBadge').classList.add('hidden'); 
            
            renderSimilar(data);
            calcDistanceOnMap(data.lat, data.lng);
            const shareUrl = `${window.location.origin}${window.location.pathname}?id=${data.id}`; 
            window.history.pushState({id: data.id}, '', shareUrl); 
            document.getElementById('waBtn').href = `https://wa.me/94726284277?text=Hi, I'm interested in: ${shareUrl}`; 
            document.getElementById('detail-view').classList.add('open'); 
        };

        function renderSimilar(current) {
            const list = document.getElementById('similarList');
            list.innerHTML = "";
            const similar = landsData.filter(l => l.id !== current.id && l.status !== 'sold' && (l.location === current.location || Math.abs((l.sortPrice||0) - (current.sortPrice||0)) < 500000)).slice(0, 3);
            if(similar.length === 0) { list.innerHTML = "<p class='text-xs text-slate-400 italic'>No similar properties found.</p>"; return; }
            similar.forEach(d => {
                const div = document.createElement('div');
                div.className = "flex gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100 cursor-pointer active:scale-95 transition";
                div.onclick = () => openDetail(d);
                div.innerHTML = `<img src="${d.imageUrls[0]}" class="w-16 h-16 rounded-lg object-cover"><div class="flex-1 min-w-0 flex flex-col justify-center"><h4 class="font-bold text-slate-800 text-xs truncate">${d.title}</h4><p class="text-[10px] text-slate-500 truncate">${d.location}</p><p class="text-green-600 font-bold text-xs">${formatPrice(d)}</p></div>`;
                list.appendChild(div);
            });
        }

        window.closeDetail = () => { document.getElementById('detail-view').classList.remove('open'); window.history.pushState({}, '', window.location.pathname); document.getElementById('mapFloatCard').classList.add('hidden'); };
        window.viewOnMap = () => { if(!currentLand) return; document.getElementById('detail-view').classList.remove('open'); switchTab('map'); map.flyTo([currentLand.lat, currentLand.lng], 15); calcDistanceOnMap(currentLand.lat, currentLand.lng); };
        
        async function calcDistanceOnMap(lat, lng) { 
            nearbyLayer.clearLayers(); 
            const list = document.getElementById('nearbyList'); 
            list.innerHTML = `<div class="flex items-center gap-3 text-slate-500"><div class="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div><span class="text-xs font-bold animate-pulse">Scanning nearby (3km)...</span></div>`; 
            
            const query = `[out:json][timeout:25];(
                nwr["amenity"~"school|hospital|bank|pharmacy|fuel|place_of_worship|police"](around:3000,${lat},${lng});
                nwr["shop"~"supermarket|convenience|grocery"](around:3000,${lat},${lng});
                nwr["highway"="bus_stop"](around:3000,${lat},${lng});
                nwr["public_transport"="station"](around:3000,${lat},${lng});
            );out center;`; 
            
            try { 
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`); 
                const data = await res.json(); 
                list.innerHTML = ""; 
                
                if(!data.elements || data.elements.length === 0) { 
                    list.innerHTML = "<p class='text-xs text-slate-400 italic'>No major landmarks found within 3km.</p>"; 
                    return; 
                }
                
                const places = data.elements.map(el => { 
                    const pLat = el.lat || (el.center && el.center.lat); 
                    const pLon = el.lon || (el.center && el.center.lon); 
                    if(!pLat || !pLon) return null; 
                    const d = map.distance([lat, lng], [pLat, pLon]); 
                    return { ...el, dist: d, lat: pLat, lon: pLon }; 
                }).filter(el => el !== null).sort((a,b) => a.dist - b.dist).slice(0, 8); 

                places.forEach(el => { 
                    const distTxt = el.dist > 1000 ? (el.dist/1000).toFixed(1)+"km" : Math.round(el.dist)+"m"; 
                    let icon='üìç', color='#64748b', typeName='Place';
                    const t = el.tags;
                    
                    if(t.amenity === 'school') { icon='üéì'; color='#2563eb'; typeName='School'; } 
                    else if(t.amenity === 'hospital') { icon='üè•'; color='#ef4444'; typeName='Hospital'; } 
                    else if(t.shop === 'supermarket' || t.shop === 'convenience' || t.shop === 'grocery') { icon='üõí'; color='#f97316'; typeName='Shop'; } 
                    else if(t.amenity === 'bank') { icon='üè¶'; color='#8b5cf6'; typeName='Bank'; }
                    else if(t.amenity === 'fuel') { icon='‚õΩ'; color='#eab308'; typeName='Fuel'; }
                    else if(t.highway === 'bus_stop' || t.public_transport === 'station') { icon='üöå'; color='#06b6d4'; typeName='Transport'; }
                    else if(t.amenity === 'pharmacy') { icon='üíä'; color='#ec4899'; typeName='Pharmacy'; }
                    else if(t.amenity === 'place_of_worship') { icon='üôè'; color='#d97706'; typeName='Worship'; }
                    else if(t.amenity === 'police') { icon='üëÆ'; color='#1e293b'; typeName='Police'; }

                    const name = t.name || t['name:si'] || t['name:en'] || typeName; 
                    list.innerHTML += `<div class="flex justify-between py-2.5 border-b border-slate-100 last:border-0 items-center group cursor-pointer hover:bg-slate-50 px-2 rounded-lg transition" onclick="map.flyTo([${el.lat}, ${el.lon}], 16)"><div class="flex items-center gap-3"><span class="text-lg bg-slate-100 w-8 h-8 flex items-center justify-center rounded-full shadow-sm">${icon}</span><div class="flex flex-col"><span class="text-xs font-bold text-slate-700 truncate max-w-[150px]">${name}</span><span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">${typeName}</span></div></div><span class="font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded text-[10px] whitespace-nowrap">${distTxt}</span></div>`; 
                    const html = `<div class="dist-marker" style="border-left-color:${color}"><div class="dist-name">${name}</div><div class="dist-val"><span>${icon}</span> ${distTxt}</div></div>`; 
                    L.marker([el.lat, el.lon], {icon: L.divIcon({className:'', html:html, iconSize:[120,40], iconAnchor:[60,45]})}).addTo(nearbyLayer); 
                }); 
            } catch(e) { 
                console.log(e); 
                list.innerHTML = "<p class='text-xs text-red-400'>Cannot load places (Network error).</p>"; 
            } 
        }

        window.shareLink = () => navigator.clipboard.writeText(window.location.href).then(() => alert("Link Copied! üîó"));
        window.slide = (n) => { idx += n; if(idx >= currentImgs.length) idx = 0; if(idx < 0) idx = currentImgs.length - 1; document.getElementById('detailImg').src = currentImgs[idx]; };
        
        loadLands();
    </script>
</body>
</html>
